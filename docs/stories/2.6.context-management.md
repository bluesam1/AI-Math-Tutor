# Story 2.6: Context Management Service

## Status

Pending

## Story

**As a** student,
**I want** the system to remember our conversation history,
**so that** the tutor can provide coherent, contextually relevant guidance.

## Acceptance Criteria

1: A backend service module is created for context management (e.g., `contextService.ts`) in TypeScript that stores and retrieves conversation context.

2: The context management service stores the last 10 messages (user inputs and system responses) for each session, using session identifiers.

3: The service uses Firestore for session storage, with session data persisting only within the browser session (no persistence beyond session).

4: The service includes functions to:

- Add a new message to the context (user input or system response)
- Retrieve the last 10 messages for a session
- Clear context when a new problem is started

5: The context is retrieved and included in LLM prompts for dialogue generation, ensuring coherent conversation flow.

6: The service handles session expiration gracefully (e.g., after 30 minutes of inactivity), clearing context when sessions expire.

7: The context management is integrated with the dialogue generation endpoint, automatically including conversation history in LLM prompts.

8: The service includes error handling for storage failures, defaulting to empty context when storage is unavailable (with graceful degradation).

## Tasks / Subtasks

- [ ] Task 1: Create Context Service Module (AC: 1)
  - [ ] Create `functions/src/services/contextService.ts`
  - [ ] Define TypeScript interfaces for context messages
  - [ ] Define TypeScript interfaces for session context
  - [ ] Create service structure with context functions
  - [ ] Export context management functions

- [ ] Task 2: Design Firestore Schema (AC: 3)
  - [ ] Design Firestore collection structure for session context
  - [ ] Define document structure (session ID, messages array, timestamp, etc.)
  - [ ] Plan indexes if needed
  - [ ] Consider TTL policies for automatic cleanup
  - [ ] Document schema design

- [ ] Task 3: Set Up Firestore Integration (AC: 3)
  - [ ] Install Firebase Admin SDK (if not already installed)
  - [ ] Configure Firestore connection
  - [ ] Initialize Firestore client
  - [ ] Test Firestore connection
  - [ ] Set up Firestore security rules (if needed)

- [ ] Task 4: Implement Add Message Function (AC: 4)
  - [ ] Create `addMessage()` function
  - [ ] Accept session ID, message content, and message type (user/system)
  - [ ] Retrieve existing context for session
  - [ ] Add new message to context
  - [ ] Maintain last 10 messages (remove oldest if > 10)
  - [ ] Update Firestore document
  - [ ] Handle errors gracefully

- [ ] Task 5: Implement Retrieve Context Function (AC: 4)
  - [ ] Create `getContext()` function
  - [ ] Accept session ID as parameter
  - [ ] Retrieve last 10 messages from Firestore
  - [ ] Format messages for LLM prompt
  - [ ] Return context array
  - [ ] Handle empty context (new session)

- [ ] Task 6: Implement Clear Context Function (AC: 4)
  - [ ] Create `clearContext()` function
  - [ ] Accept session ID as parameter
  - [ ] Delete or clear context in Firestore
  - [ ] Handle errors gracefully
  - [ ] Return success/failure status

- [ ] Task 7: Implement Session Expiration (AC: 6)
  - [ ] Set up TTL policy in Firestore (30 minutes)
  - [ ] Or implement manual expiration checking
  - [ ] Clear context when session expires
  - [ ] Handle expired sessions gracefully
  - [ ] Log session expiration events

- [ ] Task 8: Format Context for LLM Prompt (AC: 5)
  - [ ] Create `formatContextForPrompt()` function
  - [ ] Format messages as conversation history
  - [ ] Include user/system role indicators
  - [ ] Format for inclusion in LLM prompt
  - [ ] Handle empty context gracefully

- [ ] Task 9: Integrate with Dialogue Endpoint (AC: 7)
  - [ ] Update chat endpoint (Story 2.2) to use context service
  - [ ] Retrieve context when receiving message
  - [ ] Include context in LLM prompt
  - [ ] Add new message to context after generating response
  - [ ] Clear context when new problem is started

- [ ] Task 10: Implement Error Handling (AC: 8)
  - [ ] Handle Firestore connection failures
  - [ ] Handle Firestore read/write errors
  - [ ] Default to empty context when storage unavailable
  - [ ] Log errors for monitoring
  - [ ] Ensure graceful degradation (system works without context)

- [ ] Task 11: Add Session ID Generation (AC: 2)
  - [ ] Create session ID generation utility
  - [ ] Generate unique session IDs
  - [ ] Or use existing session management
  - [ ] Document session ID format
  - [ ] Handle session ID validation

- [ ] Task 12: Add Unit Tests (AC: 1-8)
  - [ ] Create test file `functions/src/services/__tests__/contextService.test.ts`
  - [ ] Test add message function
  - [ ] Test retrieve context function
  - [ ] Test clear context function
  - [ ] Test message limit (last 10 messages)
  - [ ] Test error handling
  - [ ] Mock Firestore operations

- [ ] Task 13: Integration Testing (AC: 1-8)
  - [ ] Test with real Firestore database
  - [ ] Test context storage and retrieval
  - [ ] Test session expiration
  - [ ] Test integration with dialogue endpoint
  - [ ] Test error scenarios
  - [ ] Verify context is included in LLM prompts

- [ ] Task 14: Performance Testing (AC: 1-8)
  - [ ] Measure Firestore read/write latency
  - [ ] Test with multiple concurrent sessions
  - [ ] Optimize Firestore queries
  - [ ] Ensure context retrieval doesn't slow down dialogue generation
  - [ ] Document performance characteristics

## Dependencies

- Story 2.2: Socratic Dialogue Generation Endpoint (will integrate context service)

## Required By

- Story 2.7: Chat UI Component (will use context for coherent conversations)
- Story 2.8: Progressive Help Escalation Logic (will use context for progress tracking)

## Notes

- Migration from AWS ElastiCache/Redis to Firestore is complete per migration docs
- Use Firestore TTL policies for automatic session cleanup
- Context should degrade gracefully if Firestore is unavailable
- Session data should not persist beyond browser session
- Consider using Firebase Admin SDK for server-side operations
- Review existing `apps/web/src/testUtils/contextManagement.ts` - may need backend version
