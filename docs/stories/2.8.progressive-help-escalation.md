# Story 2.8: Progressive Help Escalation Logic

## Status

Pending

## Story

**As a** student,
**I want** the system to provide more concrete hints when I'm stuck,
**so that** I can make progress without receiving direct answers.

## Acceptance Criteria

1: A backend service module is created for progressive help escalation (e.g., `helpEscalationService.ts`) in TypeScript that tracks student progress and escalates help when needed.

2: The escalation service tracks the number of turns without progress for each problem (e.g., consecutive incorrect or unclear responses).

3: When a student has been stuck for 2+ turns without progress, the system escalates help by:

- Providing more concrete hints in the LLM prompt
- Instructing the LLM to offer more specific guidance
- Maintaining Socratic principles (still asking questions, not giving direct answers)

4: The escalation logic is integrated with the dialogue generation endpoint, automatically adjusting LLM prompts based on student progress.

5: The escalation service resets progress tracking when a student makes progress (e.g., correct response, clearer understanding).

6: The escalation service maintains a history of help levels for each problem, ensuring help escalates appropriately without repeating the same hints.

7: The escalation logic is configurable, allowing for adjustment of thresholds (e.g., 2 turns, 3 turns) based on testing and feedback.

8: The escalation service includes logging for monitoring and improvement, tracking escalation rates and student progress patterns.

## Tasks / Subtasks

- [ ] Task 1: Create Help Escalation Service Module (AC: 1)
  - [ ] Create `functions/src/services/helpEscalationService.ts`
  - [ ] Define TypeScript interfaces for progress tracking
  - [ ] Define TypeScript interfaces for help levels
  - [ ] Create service structure with escalation functions
  - [ ] Export escalation functions

- [ ] Task 2: Design Progress Tracking Schema (AC: 2)
  - [ ] Design data structure for tracking student progress
  - [ ] Track turns without progress per session/problem
  - [ ] Track student responses (correct, incorrect, unclear)
  - [ ] Store progress data in Firestore or memory
  - [ ] Define progress indicators

- [ ] Task 3: Implement Progress Tracking (AC: 2)
  - [ ] Create `trackProgress()` function
  - [ ] Accept session ID, problem ID, and student response
  - [ ] Analyze response to determine if progress was made
  - [ ] Increment turns without progress counter
  - [ ] Store progress data
  - [ ] Reset counter when progress is detected

- [ ] Task 4: Implement Progress Detection (AC: 2, 5)
  - [ ] Create `detectProgress()` function
  - [ ] Analyze student response for correctness
  - [ ] Detect clearer understanding (e.g., better structured response)
  - [ ] Detect correct answers or steps
  - [ ] Return progress indicator (progress made / no progress)

- [ ] Task 5: Define Help Levels (AC: 3, 6)
  - [ ] Define help level structure (Level 1, Level 2, Level 3, etc.)
  - [ ] Define escalation thresholds (e.g., 2 turns = Level 2, 4 turns = Level 3)
  - [ ] Create help level descriptions
  - [ ] Document help level progression

- [ ] Task 6: Implement Escalation Logic (AC: 3)
  - [ ] Create `getHelpLevel()` function
  - [ ] Calculate current help level based on turns without progress
  - [ ] Return help level and escalation instructions
  - [ ] Handle threshold configuration (AC: 7)

- [ ] Task 7: Create Escalation Prompt Modifications (AC: 3)
  - [ ] Create prompt modifications for each help level
  - [ ] Level 1: Standard Socratic questions
  - [ ] Level 2: More concrete hints (still questions)
  - [ ] Level 3: Even more specific guidance (still questions)
  - [ ] Ensure all levels maintain Socratic principles
  - [ ] Never give direct answers at any level

- [ ] Task 8: Integrate with Dialogue Endpoint (AC: 4)
  - [ ] Update chat endpoint (Story 2.2) to use escalation service
  - [ ] Track progress before generating dialogue
  - [ ] Get current help level
  - [ ] Modify LLM prompt based on help level
  - [ ] Include escalation instructions in prompt

- [ ] Task 9: Implement Progress Reset (AC: 5)
  - [ ] Create `resetProgress()` function
  - [ ] Reset turns without progress counter when progress detected
  - [ ] Reset help level to Level 1
  - [ ] Clear progress history for problem
  - [ ] Handle progress reset appropriately

- [ ] Task 10: Maintain Help Level History (AC: 6)
  - [ ] Track help levels used for each problem
  - [ ] Prevent repeating same hints
  - [ ] Escalate to new help level when needed
  - [ ] Store help level history in Firestore or memory
  - [ ] Use history to guide escalation

- [ ] Task 11: Make Escalation Configurable (AC: 7)
  - [ ] Create configuration for escalation thresholds
  - [ ] Allow adjustment of turn thresholds (2 turns, 3 turns, etc.)
  - [ ] Make configuration easily adjustable
  - [ ] Document configuration options
  - [ ] Test different threshold values

- [ ] Task 12: Implement Logging (AC: 8)
  - [ ] Log escalation events (when help escalates)
  - [ ] Log progress tracking data
  - [ ] Track escalation rates (how often escalation occurs)
  - [ ] Track student progress patterns
  - [ ] Create monitoring dashboard or logs

- [ ] Task 13: Integrate with Context Service (AC: 2, 4)
  - [ ] Use context service (Story 2.6) to analyze conversation history
  - [ ] Use conversation history to detect progress
  - [ ] Use context to inform escalation decisions
  - [ ] Combine context analysis with progress tracking

- [ ] Task 14: Add Unit Tests (AC: 1-8)
  - [ ] Create test file `functions/src/services/__tests__/helpEscalationService.test.ts`
  - [ ] Test progress tracking
  - [ ] Test progress detection
  - [ ] Test escalation logic
  - [ ] Test help level determination
  - [ ] Test progress reset
  - [ ] Test configuration options

- [ ] Task 15: Integration Testing (AC: 1-8)
  - [ ] Test with real conversation scenarios
  - [ ] Test escalation after 2+ turns without progress
  - [ ] Test progress reset when progress is made
  - [ ] Test help level progression
  - [ ] Test integration with dialogue endpoint
  - [ ] Verify Socratic principles are maintained at all levels

- [ ] Task 16: Performance Testing (AC: 1-8)
  - [ ] Measure escalation service latency
  - [ ] Test with multiple concurrent sessions
  - [ ] Optimize progress tracking operations
  - [ ] Ensure escalation doesn't slow down dialogue generation
  - [ ] Document performance characteristics

## Dependencies

- Story 2.2: Socratic Dialogue Generation Endpoint (integrates escalation logic)
- Story 2.6: Context Management Service (uses context for progress analysis)

## Required By

- None (enhancement story)

## Notes

- This is an enhancement feature that improves the dialogue experience
- Must maintain Socratic principles at all help levels - never give direct answers
- Escalation should be gradual and supportive, not abrupt
- Threshold configuration allows fine-tuning based on testing and feedback
- Logging helps improve escalation logic over time
- Consider student psychology - escalation should feel helpful, not judgmental
