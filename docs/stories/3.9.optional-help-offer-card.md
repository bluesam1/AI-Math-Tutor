# Story 3.9: Optional Help Offer Card After Follow-Up

## Status

Pending

## Story

**As a** student,
**I want** to optionally request additional help after receiving a follow-up message,
**so that** I can get step-by-step guidance when I need it without being forced to engage.

## Acceptance Criteria

1: The system displays a subtle, dismissible help offer card below the tutor's follow-up message if the student hasn't responded after 5-10 seconds.

2: The help offer card appears only after the automatic contextual follow-up message (Story 3.8) has been displayed.

3: The help offer card includes:
   - A friendly, encouraging message offering step-by-step guidance
   - Clear call-to-action buttons: "Yes, please!" and "Not now"
   - A dismiss button (X) for closing the card
   - Age-appropriate language and visual design for 6th grade students

4: The help offer card automatically dismisses after 15 seconds if the student doesn't interact with it.

5: The help offer card automatically dismisses immediately if the student:
   - Types a message in the chat input
   - Sends a message
   - Clicks "Not now" or the dismiss button

6: When the student clicks "Yes, please!", the system generates a step-by-step Socratic guidance message that maintains Socratic principles (no direct answers).

7: The help offer card uses age-appropriate visual design:
   - Friendly, warm colors (e.g., light blue background)
   - Simple, clear icons (lightbulb, hand, etc.)
   - Subtle animations (fade-in, gentle slide)
   - Prominent but non-intrusive placement

8: The help offer card is responsive and works effectively on desktop, tablet, and mobile browsers.

9: The help offer card is accessible:
   - Screen reader announcements when card appears
   - Keyboard navigation for all interactive elements
   - Proper ARIA labels for all buttons and content
   - High contrast for readability

10: The help offer card maintains Socratic principles - even when providing "step-by-step guidance," it guides through questions and discovery, never providing direct answers.

11: The help offer card is non-blocking - students can continue typing and sending messages even when the card is visible.

12: The help offer card handles errors gracefully - if step-by-step guidance generation fails, the system falls back to normal chat flow without breaking the experience.

## Tasks / Subtasks

- [ ] Task 1: Create Help Offer Card Component (AC: 1, 3, 7, 8)
  - [ ] Create `apps/web/src/components/HelpOfferCard.tsx` component
  - [ ] Implement card UI with friendly, age-appropriate design
  - [ ] Add help offer message text
  - [ ] Add action buttons: "Yes, please!" and "Not now"
  - [ ] Add dismiss button (X)
  - [ ] Style with friendly colors and simple icons
  - [ ] Add subtle animations (fade-in, gentle slide)
  - [ ] Make component responsive for mobile, tablet, desktop

- [ ] Task 2: Implement Timer Logic for Delayed Display (AC: 1, 2)
  - [ ] Add timer logic to detect when follow-up message has been displayed
  - [ ] Implement 5-10 second delay before showing help offer card
  - [ ] Handle timer cleanup when component unmounts
  - [ ] Test timer accuracy and reliability
  - [ ] Add configuration for delay timing (adjustable if needed)

- [ ] Task 3: Implement Auto-Dismiss Functionality (AC: 4, 5)
  - [ ] Add 15-second auto-dismiss timer
  - [ ] Implement immediate dismiss when student types message
  - [ ] Implement immediate dismiss when student sends message
  - [ ] Implement immediate dismiss on "Not now" or dismiss button click
  - [ ] Handle timer cleanup and edge cases
  - [ ] Test auto-dismiss in all scenarios

- [ ] Task 4: Integrate Help Offer Card in Chat Panel (AC: 1, 2, 11)
  - [ ] Update `apps/web/src/components/ChatPanel.tsx` to display help offer card
  - [ ] Position card below tutor's follow-up message
  - [ ] Ensure card doesn't block chat input or message flow
  - [ ] Handle card visibility state management
  - [ ] Integrate with existing message display logic

- [ ] Task 5: Implement Help Request Handler (AC: 6, 10, 12)
  - [ ] Create handler for "Yes, please!" button click
  - [ ] Generate step-by-step Socratic guidance message
  - [ ] Ensure guidance maintains Socratic principles (no direct answers)
  - [ ] Display guidance message in chat
  - [ ] Handle guidance generation errors gracefully
  - [ ] Test guidance generation with all problem types

- [ ] Task 6: Create Step-by-Step Guidance Service (AC: 6, 10, 12)
  - [ ] Create `functions/src/services/stepByStepGuidanceService.ts` service module
  - [ ] Implement function to generate step-by-step Socratic guidance
  - [ ] Integrate with Socratic dialogue generation service
  - [ ] Ensure all generated messages pass answer detection guardrails
  - [ ] Add error handling and fallback logic
  - [ ] Add logging for guidance generation

- [ ] Task 7: Add Step-by-Step Guidance Endpoint (AC: 6, 12)
  - [ ] Create `POST /api/chat/step-by-step-guidance` endpoint
  - [ ] Accept problem context (problem text, problem type, conversation history)
  - [ ] Generate step-by-step Socratic guidance message
  - [ ] Return guidance message with validation
  - [ ] Add input validation and error handling
  - [ ] Ensure endpoint responds within 2 seconds

- [ ] Task 8: Add Step-by-Step Guidance to API Client (AC: 6)
  - [ ] Update `apps/web/src/services/api.ts` to include step-by-step guidance method
  - [ ] Add `requestStepByStepGuidance` function to API client
  - [ ] Define TypeScript interfaces for guidance request/response
  - [ ] Add error handling for guidance API calls
  - [ ] Integrate with help offer card component

- [ ] Task 9: Age-Appropriate Visual Design (AC: 7)
  - [ ] Design card with friendly, warm colors (light blue background)
  - [ ] Add simple, clear icons (lightbulb, hand, etc.)
  - [ ] Implement subtle animations (fade-in, gentle slide)
  - [ ] Ensure prominent but non-intrusive placement
  - [ ] Test visual design with target age group (if possible)
  - [ ] Refine design based on feedback

- [ ] Task 10: Accessibility Implementation (AC: 9)
  - [ ] Add screen reader announcements when card appears
  - [ ] Implement keyboard navigation for all interactive elements
  - [ ] Add proper ARIA labels for all buttons and content
  - [ ] Ensure high contrast for readability
  - [ ] Test with assistive technologies (screen readers, keyboard navigation)
  - [ ] Verify WCAG AA compliance

- [ ] Task 11: Error Handling and Edge Cases (AC: 12)
  - [ ] Handle guidance generation failures gracefully
  - [ ] Fallback to normal chat flow if generation fails
  - [ ] Handle network errors during guidance generation
  - [ ] Ensure guidance failures don't break chat flow
  - [ ] Handle edge cases (rapid clicks, multiple cards, etc.)
  - [ ] Add logging for error scenarios

- [ ] Task 12: Socratic Compliance Testing (AC: 10)
  - [ ] Test all step-by-step guidance messages pass answer detection guardrails
  - [ ] Test with various problem types
  - [ ] Verify no direct answers are provided in guidance
  - [ ] Test guidance maintains Socratic principles throughout
  - [ ] Document compliance test results

- [ ] Task 13: Integration Testing (AC: 1-12)
  - [ ] Test help offer card appears after follow-up message
  - [ ] Test help offer card appears after 5-10 second delay
  - [ ] Test help offer card auto-dismisses after 15 seconds
  - [ ] Test help offer card dismisses when student types
  - [ ] Test help offer card dismisses when student sends message
  - [ ] Test "Yes, please!" button generates guidance
  - [ ] Test "Not now" button dismisses card
  - [ ] Test dismiss button (X) dismisses card
  - [ ] Test guidance generation maintains Socratic principles
  - [ ] Test error handling scenarios
  - [ ] Test on mobile, tablet, and desktop

- [ ] Task 14: Documentation and Code Comments (AC: 1-12)
  - [ ] Document help offer card component API
  - [ ] Document step-by-step guidance service API
  - [ ] Document guidance endpoint usage
  - [ ] Add inline code comments for complex logic
  - [ ] Update README with help offer card feature description

## Dependencies

- Story 3.8: Automatic Contextual Follow-Up (must be completed first - provides follow-up message)
- Story 3.7: Answer Checking and Celebration (provides answer validation context)
- Story 2.2: Socratic Dialogue Endpoint (uses existing dialogue generation)
- Story 2.4: LLM-Based Answer Detection (must pass guardrails)
- Story 2.5: Answer Blocking & Response Rewriting (must pass guardrails)

## Required By

- Future enhancements for adaptive help offers
- Future enhancements for personalized help prompts

## Notes

- **Design Reference:** See `docs/ux-design/auto-engagement-after-validation.md` for complete UX design
- **Approach:** Optional help offer provides additional support without forcing engagement
- **Timing:** 5-10 second delay ensures student has time to respond naturally before help is offered
- **Socratic Compliance:** All guidance messages must maintain Socratic principles - no direct answers
- **Non-Intrusive:** Card is dismissible and doesn't block chat input or message flow
- **Language:** Help offer uses age-appropriate language for 6th grade students (ages 11-12)

## Technical Considerations

- **Timer Management:** Help offer card uses multiple timers (delay, auto-dismiss) that must be properly managed and cleaned up
- **State Management:** Card visibility state must be managed separately from chat flow
- **Performance:** Guidance generation must be fast (< 2 seconds) to maintain engagement
- **Error Handling:** Guidance generation failures should not break the chat experience
- **Accessibility:** Card must be fully accessible via keyboard navigation and screen readers
- **Responsive Design:** Card must work effectively on all device sizes

## Example Help Offer Messages

### After Correct Answer Follow-Up
- "Want me to help you explain your reasoning? I can guide you through it step-by-step!"
- "Want to walk through your thinking together? I can help you break it down!"
- "Need help explaining your process? I can guide you step-by-step!"

### After Incorrect Answer Follow-Up
- "Need help breaking this down? I can guide you step-by-step!"
- "Want to work through this together? I can help you step-by-step!"
- "Need some guidance? I can walk you through this step-by-step!"

### After Partial Answer Follow-Up
- "Want to work through this step-by-step together?"
- "Need help figuring out the next step? I can guide you!"
- "Want to continue working through this together? I can help!"


