# Story 1.3: Node.js/Express Backend API Structure

## Status

Draft

## Story

**As a** developer,
**I want** to establish a Node.js/Express backend API structure with basic endpoints and middleware,
**so that** the backend can handle API requests from the frontend and integrate with external services.

## Acceptance Criteria

1: A Node.js/Express backend application is initialized with TypeScript, using appropriate project structure (routes, controllers, services, middleware). All code must be written in TypeScript (no raw JavaScript).

2: Express middleware is configured for CORS (allowing frontend requests), JSON body parsing, and error handling.

3: A health check endpoint (e.g., GET /api/health) returns a success response confirming the API is running.

4: Environment variable management is configured for API keys (Vision API, LLM API) and configuration.

5: The backend is structured to support serverless deployment (AWS Lambda) or containerized deployment (ECS/Fargate), with appropriate configuration files.

6: Basic error handling middleware is implemented to catch and format errors appropriately.

7: API routes are organized in a modular structure (e.g., /api/problem, /api/chat, etc.) ready for implementation in subsequent stories.

## Tasks / Subtasks

- [ ] Task 1: Install Express Dependencies (AC: 1)
  - [ ] Install express ^4.18.0 in apps/api [Source: architecture/tech-stack.md#Backend Dependencies]
  - [ ] Install @types/express ^4.17.0
  - [ ] Install @types/node ^20.0.0
  - [ ] Verify Express is installed correctly
  - [ ] Update apps/api/package.json with Express dependencies

- [ ] Task 2: Create Backend Project Structure (AC: 1)
  - [ ] Create apps/api/src/ directory structure
  - [ ] Create apps/api/src/routes/ directory for API routes
  - [ ] Create apps/api/src/controllers/ directory for route controllers
  - [ ] Create apps/api/src/services/ directory for business logic
  - [ ] Create apps/api/src/middleware/ directory for Express middleware
  - [ ] Create apps/api/src/types/ directory for TypeScript types
  - [ ] Create apps/api/src/utils/ directory for utility functions
  - [ ] Ensure all files use .ts extension (no .js files)

- [ ] Task 3: Configure Express Server (AC: 1)
  - [ ] Create apps/api/src/server.ts entry point
  - [ ] Initialize Express app
  - [ ] Configure Express to use JSON body parser
  - [ ] Configure Express to use CORS middleware
  - [ ] Set up basic Express server listening on port
  - [ ] Configure TypeScript compilation for backend

- [ ] Task 4: Configure CORS Middleware (AC: 2)
  - [ ] Install cors package (or use Express CORS middleware)
  - [ ] Create apps/api/src/middleware/cors.ts
  - [ ] Configure CORS to allow frontend origin
  - [ ] Configure CORS for development and production environments
  - [ ] Apply CORS middleware to Express app

- [ ] Task 5: Configure JSON Body Parser (AC: 2)
  - [ ] Configure Express JSON body parser middleware
  - [ ] Set appropriate body size limits
  - [ ] Handle JSON parsing errors gracefully

- [ ] Task 6: Create Health Check Endpoint (AC: 3)
  - [ ] Create apps/api/src/routes/health.ts route file
  - [ ] Create apps/api/src/controllers/healthController.ts
  - [ ] Implement GET /api/health endpoint
  - [ ] Return success response with API status
  - [ ] Register health route in main Express app

- [ ] Task 7: Configure Error Handling Middleware (AC: 2, 6)
  - [ ] Create apps/api/src/middleware/errorHandler.ts
  - [ ] Implement error handling middleware
  - [ ] Format errors appropriately for API responses
  - [ ] Handle different error types (validation, API, network)
  - [ ] Apply error handling middleware to Express app

- [ ] Task 8: Configure Environment Variables (AC: 4)
  - [ ] Create apps/api/.env.example with template variables
  - [ ] Configure environment variable loading (dotenv or similar)
  - [ ] Create apps/api/src/config/env.ts for environment variable access
  - [ ] Document required environment variables
  - [ ] Ensure .env files are in .gitignore
  - [ ] Configure environment variables for API keys (Vision API, LLM API)

- [ ] Task 9: Create API Route Structure (AC: 7)
  - [ ] Create apps/api/src/routes/problem.ts route file (placeholder)
  - [ ] Create apps/api/src/routes/chat.ts route file (placeholder)
  - [ ] Create route modules with base paths (/api/problem, /api/chat)
  - [ ] Register route modules in main Express app
  - [ ] Ensure routes are properly typed with TypeScript

- [ ] Task 10: Configure Serverless Deployment (AC: 5)
  - [ ] Install serverless framework or configure AWS SAM/CDK
  - [ ] Create serverless.yml or SAM template for Lambda deployment
  - [ ] Configure Lambda handler function
  - [ ] Configure API Gateway integration
  - [ ] Document deployment process
  - [ ] Alternative: Configure container deployment (Dockerfile, ECS config)

- [ ] Task 11: Create TypeScript Types (AC: 1)
  - [ ] Create apps/api/src/types/api.ts for API request/response types
  - [ ] Create apps/api/src/types/env.ts for environment variable types
  - [ ] Ensure all types are properly defined
  - [ ] Export types for use in other modules

- [ ] Task 12: Test Backend Locally (AC: 1-7)
  - [ ] Configure apps/api/package.json with start script
  - [ ] Run `npm run dev` or `npm start` to start backend server
  - [ ] Test health check endpoint (GET /api/health)
  - [ ] Verify CORS is working (test from frontend)
  - [ ] Verify JSON body parsing works
  - [ ] Test error handling with invalid requests
  - [ ] Verify TypeScript compilation succeeds

## Dev Notes

### Previous Story Insights

**Story 1.1: Foundation & Project Setup**
- Monorepo structure is established with apps/api for backend
- TypeScript is configured for backend
- Environment variable management is configured at root level

**Story 1.2: React Frontend Shell**
- Frontend is ready to make API requests
- CORS must be configured to allow frontend origin

### Project Structure

The backend application structure follows the monorepo pattern: [Source: architecture/unified-project-structure.md]

```
apps/api/
├── src/
│   ├── functions/             # Lambda function handlers (if serverless)
│   ├── routes/                # API route definitions
│   │   ├── health.ts          # Health check route
│   │   ├── problem.ts         # Problem-related routes (placeholder)
│   │   └── chat.ts            # Chat-related routes (placeholder)
│   ├── controllers/           # Route controllers
│   │   ├── healthController.ts
│   │   ├── problemController.ts (placeholder)
│   │   └── chatController.ts (placeholder)
│   ├── services/              # Business logic
│   ├── middleware/            # Express middleware
│   │   ├── cors.ts            # CORS configuration
│   │   └── errorHandler.ts   # Error handling middleware
│   ├── types/                 # TypeScript type definitions
│   │   ├── api.ts             # API request/response types
│   │   └── env.ts             # Environment variable types
│   ├── utils/                 # Utility functions
│   ├── config/                # Configuration files
│   │   └── env.ts             # Environment variable access
│   └── server.ts              # Express server entry point
├── tests/                     # Backend tests
├── package.json
├── serverless.yml             # Serverless Framework config (if used)
├── tsconfig.json
└── .env.example               # Environment variable template
```

### Technology Stack Requirements

**Backend Dependencies:**
- express: ^4.18.0 [Source: architecture/tech-stack.md#Backend Dependencies]
- typescript: ^5.3.0 [Source: architecture/tech-stack.md#Backend Dependencies]
- @types/express: ^4.17.0 [Source: architecture/tech-stack.md#Backend Dependencies]
- @types/node: ^20.0.0 [Source: architecture/tech-stack.md#Backend Dependencies]
- cors: ^2.8.5 (for CORS middleware)
- dotenv: ^16.3.1 (for environment variable loading)

**AWS Dependencies (for future stories):**
- aws-sdk: ^2.1500.0 (AWS SDK v2) [Source: architecture/tech-stack.md#Backend Dependencies]
- OR @aws-sdk/client-* packages (AWS SDK v3 modular) [Source: architecture/tech-stack.md#Backend Dependencies]
- ioredis: ^5.3.0 (for ElastiCache Redis connection) [Source: architecture/tech-stack.md#Backend Dependencies]

**Serverless Framework (optional):**
- serverless: ^3.38.0 (for Lambda deployment)
- serverless-offline: ^13.0.0 (for local Lambda testing)

### Coding Standards

**Critical Rules:**
- TypeScript Only: All code must be TypeScript (no raw JavaScript) - `.ts` for backend code [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- Environment Variables: Access only through config objects, never `process.env` directly in code [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- Function Naming: camelCase for functions [Source: architecture/coding-standards.md#Naming Conventions]
- Type/Interface Naming: PascalCase [Source: architecture/coding-standards.md#Naming Conventions]

**API Design:**
- RESTful API design with clear endpoint naming
- Use appropriate HTTP methods (GET, POST, PUT, DELETE)
- Consistent error response format
- Proper HTTP status codes

### File Locations

**Server Files:**
- `apps/api/src/server.ts` - Express server entry point

**Route Files:**
- `apps/api/src/routes/health.ts` - Health check route
- `apps/api/src/routes/problem.ts` - Problem routes (placeholder)
- `apps/api/src/routes/chat.ts` - Chat routes (placeholder)

**Controller Files:**
- `apps/api/src/controllers/healthController.ts` - Health check controller
- `apps/api/src/controllers/problemController.ts` - Problem controller (placeholder)
- `apps/api/src/controllers/chatController.ts` - Chat controller (placeholder)

**Middleware Files:**
- `apps/api/src/middleware/cors.ts` - CORS configuration
- `apps/api/src/middleware/errorHandler.ts` - Error handling middleware

**Config Files:**
- `apps/api/src/config/env.ts` - Environment variable access
- `apps/api/.env.example` - Environment variable template

**Type Files:**
- `apps/api/src/types/api.ts` - API request/response types
- `apps/api/src/types/env.ts` - Environment variable types

**Deployment Files:**
- `apps/api/serverless.yml` - Serverless Framework config (if used)
- `apps/api/Dockerfile` - Docker config (if containerized)

### API Endpoints

**Health Check:**
- `GET /api/health` - Returns API status

**Future Endpoints (placeholders):**
- `POST /api/problem/parse-image` - Image parsing (Story 1.6)
- `POST /api/problem/validate` - Problem validation (Story 1.7)
- `POST /api/chat` - Chat messages (Future epic)

### Environment Variables

**Required Environment Variables:**
- `NODE_ENV` - Environment (development, production)
- `PORT` - Server port (default: 3000)
- `FRONTEND_URL` - Frontend origin for CORS
- `OPENAI_API_KEY` - OpenAI API key (for future stories)
- `ANTHROPIC_API_KEY` - Anthropic Claude API key (alternative, for future stories)
- `AWS_REGION` - AWS region for deployment
- `REDIS_HOST` - ElastiCache Redis host (for future stories)
- `REDIS_PORT` - ElastiCache Redis port (for future stories)

**Environment Variable Management:**
- Create `apps/api/.env.example` with all required variables
- Use `dotenv` for local development
- Configure environment variables in CI/CD for deployment
- Access through config object (never `process.env` directly)

### Deployment Configuration

**Serverless Deployment (AWS Lambda):**
- Use Serverless Framework or AWS SAM/CDK
- Configure Lambda handler function
- Configure API Gateway integration
- Set up environment variables in Lambda configuration

**Container Deployment (Alternative):**
- Create Dockerfile for containerized deployment
- Configure ECS/Fargate deployment
- Set up environment variables in container configuration

### Testing

**Testing Strategy:**
- Manual testing for health check endpoint
- API testing with tools like Postman or curl
- TypeScript compilation verification

**Test File Locations:**
- Backend tests: `apps/api/tests/` (to be created in later stories)
- Integration tests: `apps/api/tests/integration/` (to be created in later stories)

**Testing Requirements:**
- No unit tests required for this story (basic structure)
- Manual verification of health check endpoint
- CORS verification from frontend
- TypeScript compilation verification

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Story created | SM |

## Dev Agent Record

### Agent Model Used

_TBD - To be filled by Dev Agent_

### Debug Log References

_TBD - To be filled by Dev Agent_

### Completion Notes List

_TBD - To be filled by Dev Agent_

### File List

_TBD - To be filled by Dev Agent_

## QA Results

_TBD - To be filled by QA Agent_

