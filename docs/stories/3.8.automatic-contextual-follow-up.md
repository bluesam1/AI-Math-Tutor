# Story 3.8: Automatic Contextual Follow-Up After Answer Validation

## Status

Pending

## Story

**As a** student,
**I want** the tutor to automatically engage with me after I submit an answer,
**so that** I receive contextual guidance that helps deepen my understanding and maintains our natural conversation flow.

## Acceptance Criteria

1: The system automatically generates a contextual follow-up message immediately after answer validation completes (correct, incorrect, or partial).

2: The follow-up message is generated based on the validation result:
   - **Correct answers:** Celebrates the correct answer and asks the student to explain their thinking process (e.g., "That's correct! ðŸŽ‰ Can you walk me through how you got that answer?")
   - **Incorrect answers:** Acknowledges the attempt and offers to work through the problem together (e.g., "Let's work through this together. What information do we have?")
   - **Partial answers:** Acknowledges progress and encourages completion (e.g., "You're on the right track! What's the next step?")

3: The follow-up message appears as a normal tutor message in the chat flow, maintaining the natural conversation experience without interrupting the dialogue.

4: All generated follow-up messages maintain Socratic teaching principles:
   - Never provide direct answers to the problem
   - Always guide through questions and discovery
   - Encourage students to explain their thinking
   - Help students discover solutions themselves

5: All generated follow-up messages pass the answer detection guardrails (keyword-based and LLM-based validation) to ensure Socratic compliance.

6: The follow-up message is generated and displayed within 2 seconds of answer validation completing to maintain engaging conversation flow.

7: The follow-up message generation is non-blocking - students can continue typing and sending messages even while the follow-up is being generated.

8: The follow-up message uses age-appropriate language for 6th grade students (ages 11-12), with friendly, encouraging tone and appropriate use of emojis.

9: The follow-up message generation handles errors gracefully - if generation fails, the system falls back to normal chat flow without breaking the experience.

10: The answer checking endpoint returns a `shouldGenerateFollowUp: true` flag when answer validation completes, indicating that a follow-up should be generated.

## Tasks / Subtasks

- [ ] Task 1: Enhance Answer Checking Endpoint (AC: 10)
  - [ ] Update `functions/src/controllers/answerController.ts` to return `shouldGenerateFollowUp: true` flag
  - [ ] Add `answerValidationContext` to response structure (validation result, student answer)
  - [ ] Update response interface to include follow-up flag and context
  - [ ] Add input validation for follow-up context
  - [ ] Test endpoint returns correct flags and context

- [ ] Task 2: Enhance Socratic Dialogue Generation (AC: 2, 4, 5)
  - [ ] Update `functions/src/services/llmService.ts` to accept `answerValidationContext` parameter
  - [ ] Create prompt templates for contextual follow-ups based on validation result:
    - Correct answer follow-up template
    - Incorrect answer follow-up template
    - Partial answer follow-up template
  - [ ] Ensure all templates maintain Socratic principles (no direct answers)
  - [ ] Integrate templates into dialogue generation logic
  - [ ] Test all generated messages pass answer detection guardrails

- [ ] Task 3: Create Follow-Up Generation Service (AC: 1, 2, 4, 5)
  - [ ] Create `functions/src/services/followUpGenerationService.ts` service module
  - [ ] Implement function to generate contextual follow-up based on validation result
  - [ ] Integrate with Socratic dialogue generation service
  - [ ] Ensure all generated messages pass answer detection guardrails
  - [ ] Add error handling and fallback logic
  - [ ] Add logging for follow-up generation

- [ ] Task 4: Integrate Follow-Up Generation in Chat Panel (AC: 1, 3, 6, 7)
  - [ ] Update `apps/web/src/components/ChatPanel.tsx` to listen for answer validation events
  - [ ] Trigger follow-up generation when `shouldGenerateFollowUp: true` is returned
  - [ ] Display follow-up message as normal tutor message in chat
  - [ ] Ensure follow-up generation is non-blocking (async)
  - [ ] Handle follow-up generation errors gracefully
  - [ ] Test follow-up appears immediately after validation

- [ ] Task 5: Add Follow-Up to API Client (AC: 1, 6)
  - [ ] Update `apps/web/src/services/api.ts` to handle follow-up generation
  - [ ] Add function to generate follow-up message after validation
  - [ ] Define TypeScript interfaces for follow-up request/response
  - [ ] Add error handling for follow-up generation API calls
  - [ ] Integrate with existing answer checking flow

- [ ] Task 6: Implement Backend Follow-Up Endpoint (AC: 1, 6, 9)
  - [ ] Create `POST /api/chat/follow-up` endpoint in `functions/src/controllers/chatController.ts`
  - [ ] Accept answer validation context (result, student answer, problem text, problem type)
  - [ ] Generate contextual follow-up message using follow-up generation service
  - [ ] Return follow-up message with validation
  - [ ] Add input validation and error handling
  - [ ] Ensure endpoint responds within 2 seconds

- [ ] Task 7: Age-Appropriate Language and Tone (AC: 8)
  - [ ] Review follow-up message templates for age-appropriate language
  - [ ] Ensure friendly, encouraging tone throughout
  - [ ] Use appropriate emojis sparingly and appropriately
  - [ ] Test language is appropriate for 6th grade students (ages 11-12)
  - [ ] Update templates based on feedback

- [ ] Task 8: Error Handling and Edge Cases (AC: 9)
  - [ ] Handle follow-up generation failures gracefully
  - [ ] Fallback to normal chat flow if generation fails
  - [ ] Handle network errors during follow-up generation
  - [ ] Ensure follow-up failures don't break chat flow
  - [ ] Add logging for error scenarios

- [ ] Task 9: Socratic Compliance Testing (AC: 4, 5)
  - [ ] Test all follow-up message templates pass answer detection guardrails
  - [ ] Test with various validation results (correct, incorrect, partial)
  - [ ] Test with all 5 problem types
  - [ ] Verify no direct answers are provided in follow-ups
  - [ ] Document compliance test results

- [ ] Task 10: Integration Testing (AC: 1-10)
  - [ ] Test follow-up generation with correct answers
  - [ ] Test follow-up generation with incorrect answers
  - [ ] Test follow-up generation with partial answers
  - [ ] Test follow-up appears immediately after validation
  - [ ] Test follow-up doesn't block chat input
  - [ ] Test error handling scenarios
  - [ ] Test performance and response times (< 2 seconds)
  - [ ] Test with all 5 problem types

- [ ] Task 11: Accessibility and Responsive Design (AC: 3)
  - [ ] Ensure follow-up messages are accessible via screen readers
  - [ ] Add appropriate ARIA labels for follow-up messages
  - [ ] Test follow-up on mobile, tablet, and desktop
  - [ ] Verify keyboard navigation continues to work
  - [ ] Test with assistive technologies

- [ ] Task 12: Documentation and Code Comments (AC: 1-10)
  - [ ] Document follow-up generation service API
  - [ ] Document follow-up endpoint usage
  - [ ] Document follow-up generation logic
  - [ ] Add inline code comments for complex logic
  - [ ] Update README with follow-up feature description

## Dependencies

- Story 3.7: Answer Checking and Celebration (must be completed first - provides answer validation)
- Story 2.2: Socratic Dialogue Endpoint (uses existing dialogue generation)
- Story 2.4: LLM-Based Answer Detection (must pass guardrails)
- Story 2.5: Answer Blocking & Response Rewriting (must pass guardrails)

## Required By

- Story 3.9: Optional Help Offer Card (follow-up must be implemented first)
- Future enhancements for adaptive engagement
- Future enhancements for personalized follow-up messages

## Notes

- **Design Reference:** See `docs/ux-design/auto-engagement-after-validation.md` for complete UX design
- **Approach:** Automatic generation ensures natural conversation flow without requiring student action
- **Socratic Compliance:** All follow-up messages must maintain Socratic principles - no direct answers
- **Performance:** Follow-up generation must be fast (< 2 seconds) to maintain engagement
- **Error Handling:** Follow-up generation failures should gracefully fallback to normal chat flow
- **Language:** Follow-up messages use age-appropriate language for 6th grade students (ages 11-12)

## Technical Considerations

- **Follow-Up Generation:** Uses existing Socratic dialogue generation with enhanced context
- **Answer Detection:** All generated messages must pass answer detection guardrails
- **API Design:** Follow-up endpoint should be RESTful and follow existing API patterns
- **State Management:** Follow-up state should be managed separately from chat flow to avoid blocking
- **Performance:** Follow-up generation should be optimized to minimize latency (< 2 seconds)
- **Error Handling:** Follow-up generation failures should not break the chat experience

## Example Follow-Up Messages

### Correct Answer
- "That's correct! ðŸŽ‰ Can you walk me through how you got that answer? I'd love to hear your thinking process."
- "Great job! What steps did you take to solve this? Can you explain your reasoning?"
- "Excellent! Can you tell me how you arrived at that answer? What was your first step?"

### Incorrect Answer
- "Thanks for trying! Let's work through this together. What information do we have in the problem?"
- "Let's think about this together. What do you think might help us get started?"
- "I see you're working on this! What part of the problem are you trying to solve first?"

### Partial Answer
- "You're on the right track! What do you think we should multiply, and why?"
- "Good thinking so far! What else do we need to figure out?"
- "Nice start! Let's think about what comes next. What should we do after that step?"


