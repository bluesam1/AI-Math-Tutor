# Story 1.6: Vision API Integration Backend Endpoint

## Status

Draft

## Story

**As a** student,
**I want** my uploaded images to be parsed to extract the math problem text,
**so that** the system can understand the problem from the image.

## Acceptance Criteria

1: A backend API endpoint (e.g., POST /api/problem/parse-image) accepts image file uploads and processes them using Vision API (OpenAI Vision, Google Vision, or similar).

2: The endpoint validates the uploaded image file (format, size) before sending to Vision API.

3: The Vision API integration extracts printed text from the uploaded image, returning the problem statement as text.

4: The extracted problem text is returned to the frontend in the API response.

5: Error handling is implemented for Vision API failures (network errors, API errors, parsing failures) with clear error messages returned to the frontend.

6: The endpoint handles API rate limits gracefully, returning appropriate error messages when rate limits are reached.

7: API keys for Vision API are stored securely in environment variables and never exposed in client-side code.

8: The extracted problem text is validated to ensure it contains mathematical content (not empty, contains math-related keywords or notation).

## Tasks / Subtasks

- [ ] Task 1: Install Vision API Client Library (AC: 1, 7)
  - [ ] Install OpenAI SDK (openai package) or Google Vision API client
  - [ ] Configure API client with environment variable for API key
  - [ ] Verify API key is loaded from environment variables
  - [ ] Create API client configuration module

- [ ] Task 2: Create Image Upload Endpoint (AC: 1)
  - [ ] Create apps/api/src/routes/problem.ts route file
  - [ ] Create POST /api/problem/parse-image endpoint
  - [ ] Configure Express to handle file uploads (multer middleware)
  - [ ] Set up file upload handling with size limits
  - [ ] Register route in main Express app

- [ ] Task 3: Implement File Validation (AC: 2)
  - [ ] Create validation middleware for file format (JPG, PNG, GIF)
  - [ ] Create validation middleware for file size (max 10MB)
  - [ ] Validate file before processing
  - [ ] Return appropriate error responses for invalid files

- [ ] Task 4: Create Vision API Service (AC: 3, 7)
  - [ ] Create apps/api/src/services/visionService.ts
  - [ ] Implement function to call Vision API with image
  - [ ] Handle image conversion/formatting for API
  - [ ] Extract text from Vision API response
  - [ ] Use environment variable for API key (never hardcode)

- [ ] Task 5: Implement Text Extraction Logic (AC: 3, 4)
  - [ ] Process Vision API response to extract problem text
  - [ ] Clean and format extracted text
  - [ ] Return extracted text in API response
  - [ ] Handle cases where no text is extracted

- [ ] Task 6: Implement Error Handling (AC: 5)
  - [ ] Handle Vision API network errors
  - [ ] Handle Vision API authentication errors
  - [ ] Handle Vision API parsing failures
  - [ ] Return clear error messages to frontend
  - [ ] Log errors for debugging (without exposing sensitive data)

- [ ] Task 7: Implement Rate Limit Handling (AC: 6)
  - [ ] Detect rate limit errors from Vision API
  - [ ] Return appropriate error message for rate limits
  - [ ] Log rate limit occurrences
  - [ ] Consider implementing retry logic with exponential backoff (optional)

- [ ] Task 8: Implement Problem Text Validation (AC: 8)
  - [ ] Create validation function for extracted text
  - [ ] Check if text is not empty
  - [ ] Check if text contains math-related keywords or notation
  - [ ] Return validation status in API response
  - [ ] Handle cases where extracted text is not a math problem

- [ ] Task 9: Create API Response Types (AC: 4)
  - [ ] Create TypeScript types for API request/response
  - [ ] Define response structure for successful parsing
  - [ ] Define response structure for errors
  - [ ] Export types for use in frontend (shared types)

- [ ] Task 10: Configure Environment Variables (AC: 7)
  - [ ] Add OPENAI_API_KEY to apps/api/.env.example
  - [ ] Document Vision API key setup in README
  - [ ] Verify API key is loaded from environment
  - [ ] Ensure API key is never exposed in client code
  - [ ] Configure API key in CI/CD secrets (for deployment)

- [ ] Task 11: Test Vision API Integration (AC: 1-8)
  - [ ] Test endpoint with valid image file
  - [ ] Test endpoint with invalid file format
  - [ ] Test endpoint with file too large
  - [ ] Test error handling for API failures
  - [ ] Test rate limit handling
  - [ ] Test problem text validation
  - [ ] Verify API key is not exposed in responses

- [ ] Task 12: Create Integration with Frontend (AC: 4)
  - [ ] Create frontend API client function for image parsing
  - [ ] Update ImageUpload component to call API endpoint
  - [ ] Handle API responses (success and error)
  - [ ] Update problem state with extracted text
  - [ ] Display extracted problem in ProblemPanel

## Dev Notes

### Previous Story Insights

**Story 1.3: Backend API Structure**

- Express backend is established with middleware and error handling
- Environment variable management is configured
- API route structure is ready

**Story 1.5: Image Upload UI**

- Image upload component is implemented
- File validation is done on frontend
- Image preview is working
- File is ready for backend processing

### Project Structure

The Vision API integration extends the backend structure:

```
apps/api/src/
├── routes/
│   └── problem.ts              # NEW: Problem routes (parse-image endpoint)
├── controllers/
│   └── problemController.ts   # NEW: Problem controller
├── services/
│   └── visionService.ts        # NEW: Vision API service
├── middleware/
│   ├── fileValidation.ts      # NEW: File validation middleware
│   └── errorHandler.ts        # Already exists
├── types/
│   └── api.ts                 # Updated: API request/response types
└── config/
    └── env.ts                 # Updated: Environment variable types
```

### Technology Stack Requirements

**Backend Dependencies:**

- express: ^4.18.0 (already installed) [Source: architecture/tech-stack.md#Backend Dependencies]
- multer: ^1.4.5-lts.1 (for file upload handling)
- openai: ^4.20.0 (for OpenAI Vision API) OR @google-cloud/vision: ^3.7.0 (for Google Vision API)
- dotenv: ^16.3.1 (already installed)

**Vision API Options:**

- **OpenAI Vision API:** Use `openai` package with GPT-4 Vision model
- **Google Vision API:** Use `@google-cloud/vision` package
- **Rationale:** PRD specifies OpenAI or Google Vision - choose based on availability and cost

### Coding Standards

**Critical Rules:**

- TypeScript Only: All code must be TypeScript - `.ts` for backend code [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- Environment Variables: Access only through config objects, never `process.env` directly [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- API Security: Never expose API keys in responses or logs [Source: architecture/coding-standards.md#Critical Fullstack Rules]

**File Upload Handling:**

- Use multer middleware for file uploads
- Validate files on server side (even if validated on client)
- Limit file size to prevent DoS attacks
- Clean up temporary files after processing

### File Locations

**Backend Files:**

- `apps/api/src/routes/problem.ts` - Problem routes (NEW)
- `apps/api/src/controllers/problemController.ts` - Problem controller (NEW)
- `apps/api/src/services/visionService.ts` - Vision API service (NEW)
- `apps/api/src/middleware/fileValidation.ts` - File validation middleware (NEW)

**Type Files:**

- `apps/api/src/types/api.ts` - API request/response types (UPDATED)
- `apps/api/src/types/env.ts` - Environment variable types (UPDATED)

**Config Files:**

- `apps/api/src/config/env.ts` - Environment variable access (UPDATED)
- `apps/api/.env.example` - Environment variable template (UPDATED)

### API Endpoint Design

**Endpoint:**

- `POST /api/problem/parse-image`
- Accepts multipart/form-data with image file
- Returns JSON response with extracted text

**Request:**

```typescript
multipart/form-data:
  - image: File (JPG, PNG, GIF, max 10MB)
```

**Response (Success):**

```typescript
{
  success: true,
  problemText: string,
  confidence?: number
}
```

**Response (Error):**

```typescript
{
  success: false,
  error: string,
  code?: string
}
```

### Vision API Integration

**OpenAI Vision API:**

- Model: `gpt-4-vision-preview` or `gpt-4o` (if available)
- Convert image to base64 or use image URL
- Prompt: "Extract the math problem text from this image. Return only the problem statement, without any explanations."
- Parse response to extract text

**Google Vision API:**

- Use `text_detection` or `document_text_detection`
- Convert image to appropriate format
- Extract text from response
- Clean and format extracted text

**Error Handling:**

- Network errors: Retry with exponential backoff (optional)
- Authentication errors: Check API key configuration
- Rate limit errors: Return appropriate error message
- Parsing failures: Return error with helpful message

### File Validation

**Server-Side Validation:**

- File format: JPG, PNG, GIF (validate MIME type)
- File size: Max 10MB (validate before processing)
- File content: Verify it's actually an image (validate file signature)

**Validation Middleware:**

- Validate before Vision API call
- Return error early for invalid files
- Save API costs by validating first

### Environment Variables

**Required Environment Variables:**

- `OPENAI_API_KEY` - OpenAI API key for Vision API
- OR `GOOGLE_APPLICATION_CREDENTIALS` - Google Cloud credentials path (if using Google Vision)

**Environment Variable Management:**

- Store in `apps/api/.env` (local development)
- Store in CI/CD secrets (deployment)
- Never commit API keys to repository
- Access through config object (never `process.env` directly)

### Testing

**Testing Strategy:**

- Manual testing with sample images
- Test with valid math problem images
- Test with invalid file formats
- Test with files too large
- Test error handling for API failures
- Test rate limit handling

**Test File Locations:**

- Backend tests: `apps/api/tests/services/visionService.test.ts` (to be created in later stories)
- Integration tests: `apps/api/tests/integration/problem.test.ts` (to be created in later stories)

**Testing Requirements:**

- Manual API testing with Postman or curl
- Test with real Vision API (requires API key)
- Test error scenarios (invalid API key, network errors)
- TypeScript compilation verification

### Integration Points

**Frontend Integration:**

- Update ImageUpload component to call API endpoint
- Handle API responses (success and error)
- Update problem state with extracted text
- Display loading state during API call
- Display error messages if API fails

**Future Stories:**

- Story 1.7: Extracted text will be validated as a math problem
- Story 1.8: Validated problem will be displayed with problem type

## Change Log

| Date       | Version | Description   | Author |
| ---------- | ------- | ------------- | ------ |
| 2025-01-XX | 1.0     | Story created | SM     |

## Dev Agent Record

### Agent Model Used

_TBD - To be filled by Dev Agent_

### Debug Log References

_TBD - To be filled by Dev Agent_

### Completion Notes List

_TBD - To be filled by Dev Agent_

### File List

_TBD - To be filled by Dev Agent_

## QA Results

_TBD - To be filled by QA Agent_
