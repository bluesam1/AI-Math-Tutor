# Story 1.7: Problem Validation & Type Identification

## Status

Draft

## Story

**As a** student,
**I want** the system to validate that my input is a valid math problem and identify its type,
**so that** the tutor can guide me appropriately.

## Acceptance Criteria

1: A backend API endpoint (e.g., POST /api/problem/validate) accepts problem text (from text input or Vision API parsing) and validates it is a valid math problem.

2: The validation logic uses LLM API (OpenAI GPT-4, Claude, or similar) to analyze the problem text and confirm it is a mathematical problem (not unrelated text).

3: The system identifies the problem type from five supported categories: arithmetic, algebra, geometry, word problems, or multi-step problems.

4: The validation response includes: (1) validation status (valid/invalid), (2) problem type (if valid), (3) cleaned problem statement (if needed).

5: Error handling is implemented for invalid problems (non-math content, unclear problems) with clear, age-appropriate error messages returned to the frontend.

6: The LLM API integration is configured with appropriate prompts for problem validation and type identification.

7: API keys for LLM API are stored securely in environment variables and never exposed in client-side code.

8: The validation endpoint handles API rate limits gracefully, returning appropriate error messages when rate limits are reached.

## Tasks / Subtasks

- [ ] Task 1: Install LLM API Client Library (AC: 2, 7)
  - [ ] Install OpenAI SDK (openai package) or Anthropic SDK (anthropic package)
  - [ ] Configure API client with environment variable for API key
  - [ ] Verify API key is loaded from environment variables
  - [ ] Create API client configuration module

- [ ] Task 2: Create Problem Validation Endpoint (AC: 1)
  - [ ] Create POST /api/problem/validate endpoint in problem routes
  - [ ] Accept problem text in request body
  - [ ] Validate request body structure
  - [ ] Register endpoint in Express app

- [ ] Task 3: Create LLM Service for Validation (AC: 2, 6, 7)
  - [ ] Create apps/api/src/services/llmService.ts
  - [ ] Implement function to call LLM API for problem validation
  - [ ] Create prompt for problem validation
  - [ ] Create prompt for problem type identification
  - [ ] Parse LLM response to extract validation result
  - [ ] Use environment variable for API key (never hardcode)

- [ ] Task 4: Implement Problem Type Identification (AC: 3)
  - [ ] Define problem type categories (arithmetic, algebra, geometry, word problems, multi-step)
  - [ ] Create prompt to identify problem type
  - [ ] Parse LLM response to extract problem type
  - [ ] Validate problem type is one of the supported categories
  - [ ] Return problem type in API response

- [ ] Task 5: Implement Problem Validation Logic (AC: 2, 4)
  - [ ] Create validation function using LLM API
  - [ ] Check if problem text is a valid math problem
  - [ ] Check if problem is appropriate for 6th grade level
  - [ ] Return validation status (valid/invalid)
  - [ ] Return cleaned problem statement if needed

- [ ] Task 6: Create Validation Response Structure (AC: 4)
  - [ ] Define TypeScript types for validation response
  - [ ] Include validation status (valid/invalid)
  - [ ] Include problem type (if valid)
  - [ ] Include cleaned problem statement (if needed)
  - [ ] Export types for use in frontend (shared types)

- [ ] Task 7: Implement Error Handling (AC: 5)
  - [ ] Handle invalid problems (non-math content)
  - [ ] Handle unclear problems
  - [ ] Return clear, age-appropriate error messages
  - [ ] Handle LLM API errors (network, authentication, parsing)
  - [ ] Log errors for debugging (without exposing sensitive data)

- [ ] Task 8: Implement Rate Limit Handling (AC: 8)
  - [ ] Detect rate limit errors from LLM API
  - [ ] Return appropriate error message for rate limits
  - [ ] Log rate limit occurrences
  - [ ] Consider implementing retry logic with exponential backoff (optional)

- [ ] Task 9: Create Validation Prompts (AC: 6)
  - [ ] Design prompt for problem validation
  - [ ] Design prompt for problem type identification
  - [ ] Test prompts with sample problems
  - [ ] Refine prompts based on LLM responses
  - [ ] Document prompt structure

- [ ] Task 10: Configure Environment Variables (AC: 7)
  - [ ] Add LLM API key to apps/api/.env.example
  - [ ] Document LLM API key setup in README
  - [ ] Verify API key is loaded from environment
  - [ ] Ensure API key is never exposed in client code
  - [ ] Configure API key in CI/CD secrets (for deployment)

- [ ] Task 11: Integrate with Frontend (AC: 4)
  - [ ] Create frontend API client function for problem validation
  - [ ] Update ProblemInput component to call validation endpoint
  - [ ] Handle validation responses (success and error)
  - [ ] Update problem state with validation result
  - [ ] Display validation errors if problem is invalid

- [ ] Task 12: Test Problem Validation (AC: 1-8)
  - [ ] Test endpoint with valid math problems (all types)
  - [ ] Test endpoint with invalid problems (non-math content)
  - [ ] Test endpoint with unclear problems
  - [ ] Test problem type identification for each category
  - [ ] Test error handling for API failures
  - [ ] Test rate limit handling
  - [ ] Verify API key is not exposed in responses

## Dev Notes

### Previous Story Insights

**Story 1.4: Text Input for Math Problems**

- Text input component is implemented
- Problem state management is established

**Story 1.6: Vision API Integration**

- Image parsing endpoint is implemented
- Extracted problem text is available

### Project Structure

The problem validation extends the backend structure:

```
apps/api/src/
├── routes/
│   └── problem.ts              # UPDATED: Add validate endpoint
├── controllers/
│   └── problemController.ts   # UPDATED: Add validation controller
├── services/
│   ├── llmService.ts          # NEW: LLM API service
│   └── visionService.ts       # Already exists
├── types/
│   └── api.ts                 # UPDATED: Add validation types
└── config/
    └── env.ts                 # UPDATED: Add LLM API key
```

### Technology Stack Requirements

**Backend Dependencies:**

- express: ^4.18.0 (already installed) [Source: architecture/tech-stack.md#Backend Dependencies]
- openai: ^4.20.0 (for OpenAI GPT-4) OR anthropic: ^0.18.0 (for Anthropic Claude)
- dotenv: ^16.3.1 (already installed)

**LLM API Options:**

- **OpenAI GPT-4:** Use `openai` package with GPT-4 model
- **Anthropic Claude:** Use `anthropic` package with Claude 3 model
- **Rationale:** PRD specifies OpenAI or Claude - choose based on availability and cost

### Coding Standards

**Critical Rules:**

- TypeScript Only: All code must be TypeScript - `.ts` for backend code [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- Environment Variables: Access only through config objects, never `process.env` directly [Source: architecture/coding-standards.md#Critical Fullstack Rules]
- API Security: Never expose API keys in responses or logs [Source: architecture/coding-standards.md#Critical Fullstack Rules]

**Prompt Engineering:**

- Design clear, specific prompts for validation
- Design clear, specific prompts for type identification
- Test prompts with various problem types
- Document prompt structure and rationale

### File Locations

**Backend Files:**

- `apps/api/src/routes/problem.ts` - Problem routes (UPDATED)
- `apps/api/src/controllers/problemController.ts` - Problem controller (UPDATED)
- `apps/api/src/services/llmService.ts` - LLM API service (NEW)

**Type Files:**

- `apps/api/src/types/api.ts` - API request/response types (UPDATED)
- `packages/shared/src/types/problem.ts` - Shared problem types (NEW, for frontend/backend)

**Config Files:**

- `apps/api/src/config/env.ts` - Environment variable access (UPDATED)
- `apps/api/.env.example` - Environment variable template (UPDATED)

### API Endpoint Design

**Endpoint:**

- `POST /api/problem/validate`
- Accepts JSON with problem text
- Returns JSON response with validation result

**Request:**

```typescript
{
  problemText: string;
}
```

**Response (Success - Valid):**

```typescript
{
  success: true,
  valid: true,
  problemType: "arithmetic" | "algebra" | "geometry" | "word problems" | "multi-step",
  cleanedProblemText?: string
}
```

**Response (Success - Invalid):**

```typescript
{
  success: true,
  valid: false,
  error: string
}
```

**Response (Error):**

```typescript
{
  success: false,
  error: string,
  code?: string
}
```

### Problem Type Categories

**Supported Problem Types:**

1. **Arithmetic:** Basic operations (addition, subtraction, multiplication, division) with whole numbers, fractions, decimals
2. **Algebra:** Variables, equations, expressions (introductory algebra for 6th grade)
3. **Geometry:** Shapes, area, perimeter, volume (basic geometry for 6th grade)
4. **Word Problems:** Real-world math problems requiring problem-solving
5. **Multi-Step Problems:** Problems requiring multiple steps to solve

**6th Grade Math Focus:**

- Operations with fractions and decimals
- Ratios and proportions
- Integers
- Introductory algebra
- Basic geometry
- Multi-step word problems

### LLM Integration

**OpenAI GPT-4:**

- Model: `gpt-4` or `gpt-4-turbo`
- Prompt: "Analyze this text and determine if it is a valid 6th grade math problem. If valid, identify the problem type: arithmetic, algebra, geometry, word problems, or multi-step. Return JSON with validation status and problem type."
- Parse JSON response

**Anthropic Claude:**

- Model: `claude-3-opus` or `claude-3-sonnet`
- Similar prompt structure
- Parse JSON or structured response

**Prompt Design:**

- Clear instructions for validation
- Clear instructions for type identification
- Examples of valid/invalid problems
- Examples of each problem type
- Output format specification (JSON)

### Error Handling

**Invalid Problem Scenarios:**

- Non-math content (e.g., "What is the capital of France?")
- Unclear problems (e.g., "Solve this")
- Problems outside 6th grade level
- Empty or whitespace-only input

**Error Messages:**

- Age-appropriate, friendly messages
- Clear indication of what's wrong
- Suggestions for fixing (if applicable)
- Examples:
  - "This doesn't look like a math problem. Please enter a math problem."
  - "This problem is unclear. Please provide more details."
  - "This problem is too advanced. Please enter a 6th grade math problem."

### Environment Variables

**Required Environment Variables:**

- `OPENAI_API_KEY` - OpenAI API key (if using OpenAI)
- OR `ANTHROPIC_API_KEY` - Anthropic API key (if using Claude)

**Environment Variable Management:**

- Store in `apps/api/.env` (local development)
- Store in CI/CD secrets (deployment)
- Never commit API keys to repository
- Access through config object (never `process.env` directly)

### Testing

**Testing Strategy:**

- Manual testing with sample problems of each type
- Test with valid math problems
- Test with invalid problems (non-math content)
- Test with unclear problems
- Test problem type identification accuracy
- Test error handling for API failures
- Test rate limit handling

**Test File Locations:**

- Backend tests: `apps/api/tests/services/llmService.test.ts` (to be created in later stories)
- Integration tests: `apps/api/tests/integration/problem.test.ts` (to be created in later stories)

**Testing Requirements:**

- Manual API testing with Postman or curl
- Test with real LLM API (requires API key)
- Test error scenarios (invalid API key, network errors)
- Test with various problem types
- TypeScript compilation verification

### Integration Points

**Frontend Integration:**

- Update ProblemInput component to call validation endpoint
- Handle validation responses (success and error)
- Display validation errors if problem is invalid
- Store validation result in problem state

**Future Stories:**

- Story 1.8: Validated problem will be displayed with problem type
- Future epics: Problem type will guide Socratic dialogue approach

## Change Log

| Date       | Version | Description   | Author |
| ---------- | ------- | ------------- | ------ |
| 2025-01-XX | 1.0     | Story created | SM     |

## Dev Agent Record

### Agent Model Used

_TBD - To be filled by Dev Agent_

### Debug Log References

_TBD - To be filled by Dev Agent_

### Completion Notes List

_TBD - To be filled by Dev Agent_

### File List

_TBD - To be filled by Dev Agent_

## QA Results

_TBD - To be filled by QA Agent_


