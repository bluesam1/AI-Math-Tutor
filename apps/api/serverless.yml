service: ai-math-tutor-api

frameworkVersion: '3'

# Disable Serverless Dashboard (not required for deployment)
org: null
app: null

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-2'}
  memorySize: 512
  timeout: 30
  environment:
    NODE_ENV: ${self:provider.stage}
    FRONTEND_URL: ${env:FRONTEND_URL, 'http://localhost:3000'}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY, ''}
    ANTHROPIC_API_KEY: ${env:ANTHROPIC_API_KEY, ''}
    REDIS_HOST: ${env:REDIS_HOST, ''}
    REDIS_PORT: ${env:REDIS_PORT, '6379'}
  httpApi:
    cors:
      allowedOrigins:
        - ${env:FRONTEND_URL, 'http://localhost:3000'}
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'

functions:
  api:
    handler: src/functions/handler.handler
    events:
      - httpApi:
          path: /{proxy+}
          method: ANY
      - httpApi:
          path: /
          method: ANY

package:
  patterns:
    - '!src/**'
    - '!tests/**'
    - '!*.md'
    - '!*.tsbuildinfo'
    - '!dist/**'
    - 'package.json'
    - '.esbuild/**'
  excludeDevDependencies: true
  individually: false

plugins:
  - serverless-plugin-monorepo
  - serverless-esbuild
  - serverless-offline

custom:
  esbuild:
    bundle: true
    minify: false
    sourcemap: false
    target: node20
    platform: node
    keepNames: true
    external:
      - aws-sdk
  serverless-offline:
    httpPort: 3001
    host: localhost

